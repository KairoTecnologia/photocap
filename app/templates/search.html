{% extends "base.html" %}

{% block title %}Buscar Fotos - PhotoCap{% endblock %}

{% block extra_css %}
<style>
    .search-tabs .nav-link {
        border: none;
        border-radius: 0;
        color: #666;
    }
    
    .search-tabs .nav-link.active {
        background-color: var(--primary-color);
        color: white;
        border-bottom: 3px solid var(--primary-color);
    }
    
    .upload-area {
        border: 2px dashed #ddd;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: var(--primary-color);
        background-color: rgba(255, 107, 53, 0.05);
    }
    
    .upload-area.dragover {
        border-color: var(--primary-color);
        background-color: rgba(255, 107, 53, 0.1);
    }
    
    .preview-image {
        max-width: 200px;
        max-height: 200px;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-5">Encontre suas fotos</h1>
            
            <!-- Search Tabs -->
            <ul class="nav nav-tabs search-tabs justify-content-center mb-5" id="searchTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="event-tab" data-bs-toggle="tab" data-bs-target="#event" type="button" role="tab">
                        <i class="fas fa-search"></i> Buscar por Evento
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="face-tab" data-bs-toggle="tab" data-bs-target="#face" type="button" role="tab">
                        <i class="fas fa-user"></i> Reconhecimento Facial
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="number-tab" data-bs-toggle="tab" data-bs-target="#number" type="button" role="tab">
                        <i class="fas fa-hashtag"></i> Buscar por Número
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="searchTabsContent">
                <!-- Event Search Tab -->
                <div class="tab-pane fade show active" id="event" role="tabpanel">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <form action="{{ url_for('search') }}" method="GET">
                                <div class="input-group input-group-lg">
                                    <input type="text" name="event_name" class="form-control" 
                                           placeholder="Digite o nome do evento..." 
                                           value="{{ query }}" required>
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Face Recognition Tab -->
                <div class="tab-pane fade" id="face" role="tabpanel">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>Envie uma foto sua</h5>
                                <p class="text-muted">Arraste uma foto ou clique para selecionar</p>
                                <input type="file" id="facePhoto" accept="image/*" style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('facePhoto').click()">
                                    Selecionar Foto
                                </button>
                            </div>
                            
                            <div id="facePreview" class="text-center mt-3" style="display: none;">
                                <img id="previewImg" class="preview-image mb-3">
                                <div>
                                    <button class="btn btn-success" onclick="searchByFace()">
                                        <i class="fas fa-search"></i> Buscar Fotos
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="resetFaceSearch()">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                </div>
                            </div>
                            
                            <div id="faceResults" class="mt-4"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Number Search Tab -->
                <div class="tab-pane fade" id="number" role="tabpanel">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <form id="numberSearchForm">
                                <div class="input-group input-group-lg">
                                    <input type="text" id="numberInput" class="form-control" 
                                           placeholder="Digite seu número de peito..." 
                                           pattern="[0-9]+" required>
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </form>
                            
                            <div id="numberResults" class="mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search Results -->
    {% if events %}
    <div class="row mt-5">
        <div class="col-12">
            <h3>Resultados da busca</h3>
            <div class="row g-4">
                {% for event in events %}
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <img src="https://via.placeholder.com/400x250/ff6b35/ffffff?text={{ event.name }}" 
                             class="card-img-top" alt="{{ event.name }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ event.name }}</h5>
                            <p class="card-text text-muted">
                                <i class="fas fa-calendar"></i> {{ event.date.strftime('%d/%m/%Y') }}
                                {% if event.location %}
                                <br><i class="fas fa-map-marker-alt"></i> {{ event.location }}
                                {% endif %}
                                {% if event.category %}
                                <br><i class="fas fa-tag"></i> {{ event.category }}
                                {% endif %}
                            </p>
                            <a href="{{ url_for('event_detail', event_id=event.id) }}" class="btn btn-primary">
                                Ver Fotos
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Face Recognition
document.getElementById('facePhoto').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('facePreview').style.display = 'block';
            document.getElementById('uploadArea').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
});

function searchByFace() {
    const fileInput = document.getElementById('facePhoto');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Por favor, selecione uma foto primeiro.');
        return;
    }
    
    const formData = new FormData();
    formData.append('photo', file);
    
    fetch('/search_by_face', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        displayFaceResults(data);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar a busca. Tente novamente.');
    });
}

function displayFaceResults(data) {
    const resultsDiv = document.getElementById('faceResults');
    
    if (data.error) {
        resultsDiv.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
        return;
    }
    
    if (data.matches && data.matches.length > 0) {
        let html = '<h4>Fotos encontradas:</h4><div class="row g-3">';
        data.matches.forEach(match => {
            html += `
                <div class="col-md-4">
                    <div class="card">
                        <img src="/uploads/${match.filename}" class="card-img-top" alt="Foto encontrada">
                        <div class="card-body">
                            <p class="card-text">
                                <small class="text-muted">
                                    Similaridade: ${(match.similarity * 100).toFixed(1)}%
                                </small>
                            </p>
                            <a href="/event/${match.event_id}" class="btn btn-sm btn-primary">Ver Evento</a>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        resultsDiv.innerHTML = html;
    } else {
        resultsDiv.innerHTML = '<div class="alert alert-info">Nenhuma foto similar encontrada.</div>';
    }
}

function resetFaceSearch() {
    document.getElementById('facePhoto').value = '';
    document.getElementById('facePreview').style.display = 'none';
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('faceResults').innerHTML = '';
}

// Number Search
document.getElementById('numberSearchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const number = document.getElementById('numberInput').value;
    const formData = new FormData();
    formData.append('number', number);
    
    fetch('/search_by_number', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        displayNumberResults(data);
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar a busca. Tente novamente.');
    });
});

function displayNumberResults(data) {
    const resultsDiv = document.getElementById('numberResults');
    
    if (data.error) {
        resultsDiv.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
        return;
    }
    
    if (data.matches && data.matches.length > 0) {
        let html = '<h4>Fotos encontradas:</h4><div class="row g-3">';
        data.matches.forEach(match => {
            html += `
                <div class="col-md-4">
                    <div class="card">
                        <img src="/uploads/${match.filename}" class="card-img-top" alt="Foto encontrada">
                        <div class="card-body">
                            <p class="card-text">
                                <small class="text-muted">
                                    Confiança: ${(match.confidence * 100).toFixed(1)}%
                                </small>
                            </p>
                            <a href="/event/${match.event_id}" class="btn btn-sm btn-primary">Ver Evento</a>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        resultsDiv.innerHTML = html;
    } else {
        resultsDiv.innerHTML = '<div class="alert alert-info">Nenhuma foto com este número encontrada.</div>';
    }
}

// Drag and drop functionality
const uploadArea = document.getElementById('uploadArea');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('facePhoto').files = files;
        const event = new Event('change');
        document.getElementById('facePhoto').dispatchEvent(event);
    }
});
</script>
{% endblock %} 